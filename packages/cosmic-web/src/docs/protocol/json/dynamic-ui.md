# 协议说明

本章节概述 Cosmic Dynamic UI 的 JSON 协议要点与核心用法。

## 核心概念

在写代码前，需要理解三个关键要素：
*   **UI Schema**：描述界面结构的 JSON 对象（含 `type`, `props` 等）。
*   **Components**：Cosmic Dynamic UI 自身不包含 UI 实现，你需要提供一个字典，将协议中的 `type` 映射为具体的组件。
*   **Compiler**：通过 `compile` 方法将 Schema 和 Components 结合，生成可运行的应用实例。

## UI Schema
Cosmic Dynamic UI 引擎完全遵循 JSON UI 协议。开发者通过 JSON 对象描述视图，引擎支持以下核心语法字段。

### UI 节点语法
每个 UI 节点是一个 JSON 对象，支持以下字段：

| 属性 | 类型 | 必选 | 说明 |
| :--- | :--- | :--- | :--- |
| **type** | `string` | **是** | **节点类型**（对应组件名）。<br>• **内置容器**：`block`, `grid`, `flex` 等。<br>• **内置文本**：`text`, `paragraph` 等。<br>• **自定义**：如 `image`, `score` (需在 components 中注册)。 |
| **props** | `object` | 否 | **节点属性**。包含组件数据、样式及外观配置。 |
| **children** | `UI[]` | 否 | **子节点列表**。嵌套描述 UI 结构。 |
| **{{}}** | `string` | 否 | **插值语法**。支持在属性值或文本中使用 |
| **if** | `string` | 否 | **条件渲染**。如 `"list.length > 0"`。 |
| **for** | `string` | 否 | **循环渲染**。如 `"item, index in list"`。 |
| **events** | `object` | 否 | **交互行为**。定义事件触发时的动作。 |

### UI Props
`props` 对象用于控制组件的表现，通用字段如下：

| 属性 | 类型 | 说明 |
| :--- | :--- | :--- |
| **style** | `object` | **内联样式**。Key-Value 形式，如 `{"color": "red"}`。 |
| **class** | `string` | **类样式**。支持字符串拼接，通常对应 Design Token。 |
| **appearance** | `string` | **外观变体**。如 `primary`, `rounded` (取决于组件实现)。 |
| **[key]** | `any` | **组件属性**。透传给底层组件的 Props (如 `src`, `title`)。 |

### UI Events
`events` 对象定义交互逻辑，结构为 `{[eventName]: ActionConfig[]}`。

| 属性 | 类型 | 说明 |
| :--- | :--- | :--- |
| **events[key:string]** | `ActionConfig[]` | **交互事件**。如 `click`, `change`，对应组件抛出的事件。 |
| **action** | `string` | **交互事件的名称**。必填，如 `link`, `toast` (需在 actions 中注册)。 |
| **option** | `object` | **行为参数**。支持插值，可引用：<br>• &#123;&#123;value&#125;&#125;: 当前作用域下的变量<br>• &#123;&#123;$event.xxx&#125;&#125;: 当前组件事件参数<br>• &#123;&#123;$data.xxx&#125;&#125;: 当前环境下的数据 |

### UI 数据

#### 静态值
支持静态数据

- 基础类型： number \| boolean \| string \| null | undefined
- 引用类型：Object | Array 等

#### 插值
插值的语法形式是表达式位于双大括号中。插值可引用数据环境的数据，插值内可应用表达式。[语法同 SAN 插值](https://baidu.github.io/san/tutorial/template/#%E8%A1%A8%E8%BE%BE%E5%BC%8F)

```
<!-- 普通变量 -->
"&#123;&#123;name&#125;&#125;"

<!-- 属性访问 -->
"&#123;&#123;person.name&#125;&#125;"
"&#123;&#123;persons[1]&#125;&#125;"

<!-- 一元否定 -->
"&#123;&#123;!isOK&#125;&#125;"
"&#123;&#123;!!isOK&#125;&#125;"

<!-- 一元取负 -->
"&#123;&#123;-num1 + num2&#125;&#125;"

<!-- 二元运算 -->
"&#123;&#123;num1 + num2&#125;&#125;"
"&#123;&#123;num1 - num2&#125;&#125;"
"&#123;&#123;num1 * num2&#125;&#125;"
"&#123;&#123;num1 / num2&#125;&#125;"
"&#123;&#123;num1 + num2 * num3&#125;&#125;"

<!-- 二元关系 -->
"&#123;&#123;num1 > num2&#125;&#125;"
"&#123;&#123;num1 !== num2&#125;&#125;"

<!-- 三元条件 -->
"&#123;&#123;num1 > num2 ? num1 : num2&#125;&#125;"

<!-- 括号 -->
"&#123;&#123;a * (b + c)&#125;&#125;"

<!-- 数值 -->
"&#123;&#123;num1 + 200&#125;&#125;"

<!-- 字符串 + 三元条件 -->
"&#123;&#123;item ? ',' + item : ''&#125;&#125;"

<!-- 数组字面量 -->
<x-list data="&#123;&#123; persons || [] &#125;&#125;"

<!-- 对象字面量 -->
"&#123;&#123; {title: articleTitle, author: user} &#125;&#125;"

<!-- 方法调用 -->
"&#123;&#123;max(num1, num2)&#125;&#125;"
```
